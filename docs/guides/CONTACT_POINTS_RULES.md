# 查看联系方式积分规则说明

## 规则概述

查看商家联系方式的积分消耗根据**查看者身份**和**被查看者身份**有不同的规则。

## 详细规则

### 1. 注册用户查看商家联系方式

**规则**: 双方各扣 10 积分

**扣分逻辑**:
- 👤 **注册用户(查看方)**: -10 积分
- 🏪 **商家(被查看方)**: -10 积分

**积分记录**:
- 查看方记录: "查看商家【xxx】联系方式 -10积分"
- 商家方记录: "联系方式被注册用户查看 -10积分"

**前置条件**:
- 查看方积分 ≥ 10
- 商家方积分 ≥ 10

**业务逻辑**:
```
注册用户想获取商家联系信息 → 支付 10 积分
商家的联系方式被查看 → 扣除 10 积分(作为获客成本)
```

---

### 2. 商家查看商家联系方式

**规则**: 仅查看方扣 50 积分,被查看方不扣分

**扣分逻辑**:
- 🏪 **商家A(查看方)**: -50 积分
- 🏪 **商家B(被查看方)**: 不扣分

**积分记录**:
- 查看方记录: "查看商家【xxx】联系方式 -50积分"
- 被查看方: 无记录

**前置条件**:
- 查看方积分 ≥ 50

**业务逻辑**:
```
商家之间互相查看联系方式 → 查看方支付更高费用(50积分)
被查看方不扣分 → 鼓励商家之间合作交流
```

---

### 3. 商家查看自己的联系方式

**规则**: 完全免费,不扣分

**扣分逻辑**:
- 🏪 **商家(本人)**: 0 积分

**积分记录**:
- 无记录

**业务逻辑**:
```
商家查看自己的信息 → 免费
避免商家误操作扣分
```

---

## 规则总结表

| 查看者身份 | 被查看者身份 | 查看方扣分 | 被查看方扣分 | 总消耗 |
|----------|------------|----------|------------|-------|
| 注册用户 | 商家 | -10 | -10 | 20 |
| 商家 | 其他商家 | -50 | 0 | 50 |
| 商家 | 自己 | 0 | 0 | 0 |

## 代码实现

### 核心逻辑

文件: `lib/actions/contact.ts`

```typescript
// 判断查看者身份
const isViewerMerchant = viewerProfile.is_merchant
const pointsToDeduct = isViewerMerchant ? 50 : 10  // 商家查看50分,用户查看10分

// 检查查看者积分是否足够
if (viewerProfile.points < pointsToDeduct) {
  throw new Error(`积分不足，需要${pointsToDeduct}积分`)
}

// 如果是注册用户查看商家，还需要检查商家积分
if (!isViewerMerchant) {
  if (merchantProfile.points < 10) {
    throw new Error("该商家积分不足，暂时无法查看")
  }
}

// 扣除查看者积分
await updateUserPoints(user.id, -pointsToDeduct)
await addPointsLog(/* 记录查看方积分变动 */)

// 如果是注册用户查看商家，商家也扣除积分
if (!isViewerMerchant) {
  await updateUserPoints(merchantProfile.id, -10)
  await addPointsLog(/* 记录商家方积分变动 */)
}
```

## 测试场景

### 场景1: 注册用户查看商家

**前置条件**:
- 用户A: 注册用户, 积分 50
- 商家B: 商家, 积分 100

**操作**: 用户A 查看 商家B 的联系方式

**预期结果**:
- 用户A 积分: 50 - 10 = 40
- 商家B 积分: 100 - 10 = 90
- 用户A 积分记录: "查看商家【商家B】联系方式 -10积分"
- 商家B 积分记录: "联系方式被注册用户查看 -10积分"

---

### 场景2: 商家查看商家

**前置条件**:
- 商家A: 商家, 积分 100
- 商家B: 商家, 积分 100

**操作**: 商家A 查看 商家B 的联系方式

**预期结果**:
- 商家A 积分: 100 - 50 = 50
- 商家B 积分: 100 (不变)
- 商家A 积分记录: "查看商家【商家B】联系方式 -50积分"
- 商家B 积分记录: 无新记录

---

### 场景3: 商家查看自己

**前置条件**:
- 商家A: 商家, 积分 100

**操作**: 商家A 查看 自己 的联系方式

**预期结果**:
- 商家A 积分: 100 (不变)
- 商家A 积分记录: 无新记录

---

### 场景4: 积分不足 - 注册用户

**前置条件**:
- 用户A: 注册用户, 积分 5
- 商家B: 商家, 积分 100

**操作**: 用户A 查看 商家B 的联系方式

**预期结果**:
- ❌ 操作失败
- 错误提示: "积分不足，需要10积分"

---

### 场景5: 积分不足 - 商家积分不足

**前置条件**:
- 用户A: 注册用户, 积分 50
- 商家B: 商家, 积分 5

**操作**: 用户A 查看 商家B 的联系方式

**预期结果**:
- ❌ 操作失败
- 错误提示: "该商家积分不足，暂时无法查看"

---

### 场景6: 积分不足 - 商家查看商家

**前置条件**:
- 商家A: 商家, 积分 30
- 商家B: 商家, 积分 100

**操作**: 商家A 查看 商家B 的联系方式

**预期结果**:
- ❌ 操作失败
- 错误提示: "积分不足，需要50积分"

## 常见问题

### Q1: 为什么注册用户查看时商家也要扣分?

**A**: 这是为了防止商家通过大量曝光联系方式来消耗平台资源。商家需要为每次被查看支付成本,这样可以:
1. 鼓励商家提供高质量服务吸引真实客户
2. 防止恶意注册或垃圾信息
3. 平衡平台生态

### Q2: 为什么商家查看商家要50积分,而不是10积分?

**A**: 商家之间互相查看通常是为了:
1. 同行竞品调研
2. 寻找合作伙伴
3. 学习参考

收取更高费用(50积分)可以:
1. 避免恶意查看竞争对手信息
2. 确保查看行为更有目的性
3. 保护商家隐私

### Q3: 为什么被查看的商家不扣分?

**A**: 在"商家查看商家"场景中,被查看方不扣分是为了:
1. 鼓励商家信息透明化
2. 促进商家之间合作
3. 查看方已支付较高费用(50积分),不需要双方都扣分

### Q4: 如果商家积分不足,用户能查看吗?

**A**: 不能。这是为了:
1. 确保商家维持一定的活跃度
2. 防止"僵尸商家"占用展示资源
3. 鼓励商家通过签到、邀请等方式赚取积分

### Q5: 商家能无限次查看自己的信息吗?

**A**: 可以。商家查看自己的信息完全免费,不限次数。这是合理的需求。

## 设计理念

这套积分规则的设计遵循以下原则:

1. **公平性**: 获取信息需要付出成本,但成本合理
2. **可持续性**: 商家需要维持积分来接受查看,促进活跃度
3. **差异化**: 不同身份的用户有不同的权限和成本
4. **防滥用**: 通过积分门槛防止恶意查看和垃圾信息
5. **激励正向行为**: 通过签到、邀请等方式鼓励用户活跃

## 相关文件

- `lib/actions/contact.ts` - 查看联系方式的核心逻辑
- `lib/actions/points.ts` - 积分记录和变动函数
- `app/merchant/[id]/page.tsx` - 商家详情页(查看联系方式入口)
- `POINTS_HISTORY_FEATURE.md` - 积分记录功能总体文档

---

**版本**: 1.0.0
**更新日期**: 2025-01-05
