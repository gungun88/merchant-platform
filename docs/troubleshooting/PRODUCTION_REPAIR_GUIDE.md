# ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“ä¿®å¤æŒ‡å—

## ğŸ“‹ é—®é¢˜æ€»ç»“

**å¼€å‘ç¯å¢ƒ**: 25 ä¸ªè¡¨
**ç”Ÿäº§ç¯å¢ƒ**: 23 ä¸ªè¡¨
**ç¼ºå¤±çš„è¡¨**: 2 ä¸ª

### ç¼ºå¤±çš„è¡¨æ¸…å•:
1. âœ— `admin_operation_logs` - ç®¡ç†å‘˜æ“ä½œæ—¥å¿—è¡¨
2. âœ— `deposit_top_up_applications` - æŠ¼é‡‘è¿½åŠ ç”³è¯·è¡¨

### Storage æ¡¶å·®å¼‚:
- **å¼€å‘ç¯å¢ƒ**: `public`, `platform-assets`
- **ç”Ÿäº§ç¯å¢ƒ**: `public`, `platform-assets`, `deposit-merchant-assets` (å¤šä½™)

---

## ğŸ”§ ä¿®å¤æ­¥éª¤

### ç¬¬ 1 æ­¥: å¤‡ä»½ç”Ÿäº§æ•°æ®åº“ï¼ˆé‡è¦ï¼ï¼‰

åœ¨æ‰§è¡Œä»»ä½•ä¿®å¤æ“ä½œä¹‹å‰ï¼Œè¯·å…ˆå¤‡ä»½ç”Ÿäº§æ•°æ®åº“ï¼š

1. ç™»å½• **Supabase Dashboard** â†’ è¿›å…¥ç”Ÿäº§ç¯å¢ƒé¡¹ç›®
2. ç‚¹å‡» **Database** â†’ **Backups** â†’ **Create backup**
3. ç­‰å¾…å¤‡ä»½å®Œæˆåå†ç»§ç»­

---

### ç¬¬ 2 æ­¥: æ‰§è¡Œæ•°æ®åº“ä¿®å¤è„šæœ¬

#### æ–¹å¼ä¸€ï¼šé€šè¿‡ Supabase Dashboard SQL Editorï¼ˆæ¨èï¼‰

1. ç™»å½• **Supabase Dashboard** â†’ ç”Ÿäº§ç¯å¢ƒé¡¹ç›®
2. ç‚¹å‡» **SQL Editor** â†’ **New query**
3. æ‰“å¼€æ–‡ä»¶ `scripts/production_repair_missing_tables.sql`
4. å¤åˆ¶æ‰€æœ‰å†…å®¹ï¼Œç²˜è´´åˆ° SQL Editor
5. ç‚¹å‡» **Run** æ‰§è¡Œè„šæœ¬
6. ç­‰å¾…æ‰§è¡Œå®Œæˆï¼ŒæŸ¥çœ‹è¾“å‡ºä¿¡æ¯ï¼š

```sql
========================================
ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“ä¿®å¤å®Œæˆï¼
========================================
admin_operation_logs è¡¨: âœ“ å·²åˆ›å»º
deposit_top_up_applications è¡¨: âœ“ å·²åˆ›å»º
========================================
æ‰€æœ‰ç¼ºå¤±çš„è¡¨å·²æˆåŠŸåˆ›å»ºï¼
```

#### æ–¹å¼äºŒï¼šé€šè¿‡å‘½ä»¤è¡Œï¼ˆéœ€è¦ Supabase CLIï¼‰

```bash
# ç¡®ä¿ä½ å·²ç™»å½• Supabase CLI
supabase login

# é“¾æ¥åˆ°ç”Ÿäº§é¡¹ç›®
supabase link --project-ref <your-production-project-id>

# æ‰§è¡Œä¿®å¤è„šæœ¬
supabase db push --file scripts/production_repair_missing_tables.sql
```

---

### ç¬¬ 3 æ­¥: éªŒè¯è¡¨åˆ›å»ºæˆåŠŸ

åœ¨ **SQL Editor** ä¸­æ‰§è¡Œä»¥ä¸‹æŸ¥è¯¢ï¼Œæ£€æŸ¥è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸï¼š

```sql
-- æŸ¥è¯¢æ‰€æœ‰è¡¨
SELECT
  table_name,
  CASE
    WHEN table_name IN ('admin_operation_logs', 'deposit_top_up_applications')
    THEN 'âœ“ æ–°å¢'
    ELSE 'åŸæœ‰'
  END AS status
FROM information_schema.tables
WHERE table_schema = 'public'
  AND table_type = 'BASE TABLE'
ORDER BY table_name;
```

é¢„æœŸç»“æœåº”è¯¥æ˜¾ç¤º **25 ä¸ªè¡¨**ï¼ˆä¸å¼€å‘ç¯å¢ƒä¸€è‡´ï¼‰ã€‚

---

### ç¬¬ 4 æ­¥: éªŒè¯ Storage æ¡¶

#### æ£€æŸ¥ç°æœ‰çš„ Storage æ¡¶:

1. ç™»å½• **Supabase Dashboard** â†’ **Storage**
2. åº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ¡¶ï¼š
   - âœ“ `public` - ç”¨äºå­˜å‚¨å•†å®¶ logoã€åˆä½œä¼™ä¼´ logo ç­‰
   - âœ“ `platform-assets` - ç”¨äºå­˜å‚¨å¹³å°èµ„æº

#### å…³äº `deposit-merchant-assets` æ¡¶:

ç”Ÿäº§ç¯å¢ƒæœ‰ä¸€ä¸ªå¤šä½™çš„æ¡¶ `deposit-merchant-assets`ï¼Œå®ƒåœ¨å¼€å‘ç¯å¢ƒä¸­ä¸å­˜åœ¨ã€‚

**å¤„ç†å»ºè®®**:
- å¦‚æœæ¡¶æ˜¯**ç©ºçš„**æˆ–**æ— ç”¨çš„**ï¼Œå¯ä»¥åˆ é™¤å®ƒ
- å¦‚æœæ¡¶ä¸­æœ‰æ–‡ä»¶ï¼Œè¯·å…ˆæ£€æŸ¥è¿™äº›æ–‡ä»¶æ˜¯å¦é‡è¦
- å¦‚æœä¸ç¡®å®šï¼Œ**æš‚æ—¶ä¿ç•™**ï¼Œä¸è¦åˆ é™¤

---

### ç¬¬ 5 æ­¥: éªŒè¯ RLS ç­–ç•¥

æ‰§è¡Œä»¥ä¸‹ SQL æŸ¥è¯¢ï¼Œæ£€æŸ¥å…³é”®è¡¨çš„ RLS ç­–ç•¥ï¼š

```sql
-- æ£€æŸ¥ merchants è¡¨çš„ RLS ç­–ç•¥
SELECT
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd
FROM pg_policies
WHERE tablename = 'merchants'
ORDER BY policyname;

-- æ£€æŸ¥ deposit_merchant_applications è¡¨çš„ RLS ç­–ç•¥
SELECT
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd
FROM pg_policies
WHERE tablename = 'deposit_merchant_applications'
ORDER BY policyname;

-- æ£€æŸ¥ storage.objects çš„ RLS ç­–ç•¥
SELECT
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd
FROM pg_policies
WHERE tablename = 'objects' AND schemaname = 'storage'
ORDER BY policyname;
```

---

### ç¬¬ 6 æ­¥: æµ‹è¯•æŠ¼é‡‘å•†å®¶åŠŸèƒ½

ä¿®å¤å®Œæˆåï¼Œéœ€è¦æµ‹è¯•æŠ¼é‡‘å•†å®¶åŠŸèƒ½æ˜¯å¦æ­£å¸¸ï¼š

#### æµ‹è¯•æ¸…å•:

1. **å•†å®¶åå°æµ‹è¯•**:
   - âœ… ç™»å½•å•†å®¶è´¦æˆ·
   - âœ… è®¿é—®å•†å®¶åå°ï¼ˆ`/merchant/dashboard`ï¼‰
   - âœ… æ£€æŸ¥æ˜¯å¦èƒ½æ­£ç¡®æ˜¾ç¤ºæŠ¼é‡‘å•†å®¶çŠ¶æ€
   - âœ… å¦‚æœæ˜¯æŠ¼é‡‘å•†å®¶ï¼Œåº”è¯¥æ˜¾ç¤º"æŠ¼é‡‘å•†å®¶"å¡ç‰‡ï¼ŒåŒ…å«æŠ¼é‡‘é‡‘é¢ã€ç¼´çº³æ—¶é—´ç­‰
   - âœ… æµ‹è¯•"é¢†å–ä»Šæ—¥å¥–åŠ±"æŒ‰é’®åŠŸèƒ½

2. **ç®¡ç†å‘˜åå°æµ‹è¯•**:
   - âœ… ç™»å½•ç®¡ç†å‘˜è´¦æˆ·
   - âœ… è®¿é—®æŠ¼é‡‘ç”³è¯·å®¡æ ¸é¡µé¢ï¼ˆ`/admin/deposits/applications`ï¼‰
   - âœ… æµ‹è¯•æ‰¹å‡†/æ‹’ç»æŠ¼é‡‘ç”³è¯·åŠŸèƒ½
   - âœ… æ£€æŸ¥ç®¡ç†å‘˜æ“ä½œæ—¥å¿—æ˜¯å¦æ­£å¸¸è®°å½•ï¼ˆ`admin_operation_logs` è¡¨ï¼‰

3. **è¿½åŠ æŠ¼é‡‘åŠŸèƒ½æµ‹è¯•**:
   - âœ… å·²æ˜¯æŠ¼é‡‘å•†å®¶çš„è´¦æˆ·ï¼Œç‚¹å‡»"è¿½åŠ æŠ¼é‡‘"æŒ‰é’®
   - âœ… æäº¤è¿½åŠ ç”³è¯·
   - âœ… ç®¡ç†å‘˜å®¡æ ¸è¿½åŠ ç”³è¯·
   - âœ… æ£€æŸ¥æŠ¼é‡‘é‡‘é¢æ˜¯å¦æ­£ç¡®ç´¯åŠ 

4. **å‰ç«¯å±•ç¤ºæµ‹è¯•**:
   - âœ… è®¿é—®é¦–é¡µå•†å®¶åˆ—è¡¨
   - âœ… æ£€æŸ¥æŠ¼é‡‘å•†å®¶æ˜¯å¦æ˜¾ç¤º"å·²è®¤è¯"å¾½ç« 
   - âœ… æ£€æŸ¥å•†å®¶è¯¦æƒ…é¡µæ˜¯å¦æ­£ç¡®æ˜¾ç¤ºæŠ¼é‡‘å•†å®¶ä¿¡æ¯

---

## ğŸ” å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: å•†å®¶åå°æ˜¾ç¤º "Apply Now" è€Œä¸æ˜¯ "Deposit Merchant Active"

**å¯èƒ½åŸå› **:
- RLS ç­–ç•¥é˜»æ­¢äº† `getUserMerchant()` æŸ¥è¯¢
- ç”¨æˆ·è®¤è¯ token å¤±æ•ˆ

**è§£å†³æ–¹æ³•**:
1. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
2. å°è¯•é€€å‡ºå¹¶é‡æ–°ç™»å½•
3. æ£€æŸ¥ `merchants` è¡¨çš„ RLS ç­–ç•¥æ˜¯å¦æ­£ç¡®

```sql
-- æ£€æŸ¥ merchants è¡¨çš„ SELECT ç­–ç•¥
SELECT * FROM pg_policies WHERE tablename = 'merchants' AND cmd = 'SELECT';
```

é¢„æœŸåº”è¯¥æœ‰ä»¥ä¸‹ç­–ç•¥ï¼š
- âœ… `merchants_select_policy` - å…è®¸ç”¨æˆ·æŸ¥çœ‹è‡ªå·±çš„å•†å®¶æˆ–æ¿€æ´»çš„å•†å®¶
- âœ… `ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å•†å®¶` - å…è®¸ç®¡ç†å‘˜æŸ¥çœ‹æ‰€æœ‰å•†å®¶

### é—®é¢˜ 2: Storage ä¸Šä¼ æ–‡ä»¶å¤±è´¥

**å¯èƒ½åŸå› **:
- `public` æ¡¶ä¸å­˜åœ¨
- Storage çš„ RLS ç­–ç•¥é…ç½®ä¸æ­£ç¡®

**è§£å†³æ–¹æ³•**:
1. æ£€æŸ¥ `public` æ¡¶æ˜¯å¦å­˜åœ¨ï¼ˆDashboard â†’ Storageï¼‰
2. å¦‚æœä¸å­˜åœ¨ï¼Œæ‰‹åŠ¨åˆ›å»ºï¼š
   - Bucket name: `public`
   - Public bucket: âœ“ (å‹¾é€‰)
   - File size limit: `5242880` (5MB)
   - Allowed MIME types: `image/jpeg, image/png, image/gif, image/webp`

3. æ‰§è¡Œ Storage ç­–ç•¥è„šæœ¬ï¼š
```bash
# åœ¨ SQL Editor æ‰§è¡Œ
scripts/032.9_setup_storage_policies.sql
```

### é—®é¢˜ 3: ç®¡ç†å‘˜æ“ä½œæ—¥å¿—æ— æ³•è®°å½•

**å¯èƒ½åŸå› **:
- `admin_operation_logs` è¡¨æœªåˆ›å»º
- RLS ç­–ç•¥é˜»æ­¢æ’å…¥

**è§£å†³æ–¹æ³•**:
1. ç¡®è®¤è¡¨å·²åˆ›å»ºï¼š
```sql
SELECT * FROM information_schema.tables
WHERE table_name = 'admin_operation_logs';
```

2. æ£€æŸ¥ RLS ç­–ç•¥ï¼š
```sql
SELECT * FROM pg_policies
WHERE tablename = 'admin_operation_logs';
```

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰:
- âŒ ç”Ÿäº§ç¯å¢ƒç¼ºå°‘ 2 ä¸ªè¡¨
- âŒ æŠ¼é‡‘å•†å®¶åŠŸèƒ½å¼‚å¸¸
- âŒ ç®¡ç†å‘˜æ“ä½œæ—¥å¿—æ— æ³•è®°å½•
- âŒ è¿½åŠ æŠ¼é‡‘åŠŸèƒ½æ— æ³•ä½¿ç”¨

### ä¿®å¤å:
- âœ… ç”Ÿäº§ç¯å¢ƒè¡¨æ•°é‡ä¸å¼€å‘ç¯å¢ƒä¸€è‡´ï¼ˆ25 ä¸ªè¡¨ï¼‰
- âœ… æŠ¼é‡‘å•†å®¶åŠŸèƒ½æ­£å¸¸
- âœ… ç®¡ç†å‘˜æ“ä½œæ—¥å¿—æ­£å¸¸è®°å½•
- âœ… è¿½åŠ æŠ¼é‡‘åŠŸèƒ½æ­£å¸¸ä½¿ç”¨

---

## ğŸš€ åç»­éƒ¨ç½²å»ºè®®

### é¿å…æœªæ¥å‡ºç°ç±»ä¼¼é—®é¢˜:

1. **ä½¿ç”¨æ•°æ®åº“è¿ç§»å·¥å…·**:
   - ä½¿ç”¨ Supabase CLI çš„è¿ç§»åŠŸèƒ½
   - æ¯æ¬¡æ•°æ®åº“å˜æ›´éƒ½åˆ›å»ºè¿ç§»æ–‡ä»¶
   - æŒ‰é¡ºåºæ‰§è¡Œè¿ç§»æ–‡ä»¶

2. **ç¯å¢ƒåŒæ­¥æµç¨‹**:
   ```bash
   # å¼€å‘ç¯å¢ƒ â†’ ç”Ÿäº§ç¯å¢ƒ

   # 1. åœ¨å¼€å‘ç¯å¢ƒåˆ›å»ºè¿ç§»æ–‡ä»¶
   supabase db diff --use-migra -f new_migration

   # 2. æµ‹è¯•è¿ç§»æ–‡ä»¶
   supabase db reset

   # 3. æ¨é€åˆ°ç”Ÿäº§ç¯å¢ƒ
   supabase link --project-ref <production-id>
   supabase db push
   ```

3. **å®šæœŸæ£€æŸ¥ç¯å¢ƒä¸€è‡´æ€§**:
   - æ¯å‘¨æ‰§è¡Œè¡¨æ•°é‡å¯¹æ¯”æŸ¥è¯¢
   - æ£€æŸ¥ RLS ç­–ç•¥æ˜¯å¦ä¸€è‡´
   - æ£€æŸ¥ Storage æ¡¶é…ç½®æ˜¯å¦ä¸€è‡´

4. **ä¿æŒæ–‡æ¡£æ›´æ–°**:
   - è®°å½•æ¯æ¬¡æ•°æ®åº“å˜æ›´
   - æ›´æ–°éƒ¨ç½²æ–‡æ¡£
   - è®°å½•å·²çŸ¥é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœåœ¨ä¿®å¤è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. æ£€æŸ¥ Supabase Dashboard çš„æ—¥å¿—ï¼ˆLogs â†’ Postgres Logsï¼‰
2. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯
3. æ£€æŸ¥æœ¬æ–‡æ¡£çš„"å¸¸è§é—®é¢˜æ’æŸ¥"éƒ¨åˆ†
4. ä¿ç•™é”™è¯¯ä¿¡æ¯æˆªå›¾ï¼Œä»¥ä¾¿è¿›ä¸€æ­¥åˆ†æ

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

ä¿®å¤å®Œæˆåï¼Œè¯·ç¡®è®¤ä»¥ä¸‹æ‰€æœ‰é¡¹ç›®ï¼š

- [ ] å·²å¤‡ä»½ç”Ÿäº§æ•°æ®åº“
- [ ] å·²æ‰§è¡Œä¿®å¤è„šæœ¬ `production_repair_missing_tables.sql`
- [ ] ç”Ÿäº§ç¯å¢ƒè¡¨æ•°é‡ä¸º 25 ä¸ªï¼ˆä¸å¼€å‘ç¯å¢ƒä¸€è‡´ï¼‰
- [ ] `admin_operation_logs` è¡¨å·²åˆ›å»º
- [ ] `deposit_top_up_applications` è¡¨å·²åˆ›å»º
- [ ] æ‰€æœ‰ RLS ç­–ç•¥å·²æ­£ç¡®é…ç½®
- [ ] Storage æ¡¶ `public` å’Œ `platform-assets` å·²å­˜åœ¨
- [ ] å•†å®¶åå°å¯ä»¥æ­£ç¡®æ˜¾ç¤ºæŠ¼é‡‘å•†å®¶çŠ¶æ€
- [ ] ç®¡ç†å‘˜å¯ä»¥å®¡æ ¸æŠ¼é‡‘ç”³è¯·
- [ ] è¿½åŠ æŠ¼é‡‘åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] å‰ç«¯å•†å®¶åˆ—è¡¨æ­£å¸¸æ˜¾ç¤º

å…¨éƒ¨å®Œæˆåï¼Œç”Ÿäº§ç¯å¢ƒæ•°æ®åº“ä¿®å¤å®Œæˆï¼ğŸ‰
