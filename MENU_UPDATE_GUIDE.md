# 新功能数据库迁移指南

## 概述

本次更新添加了以下功能：
1. **商家上下架功能** - 商家可以暂时下架自己的服务
2. **举报功能** - 用户可以举报违规商家
3. **置顶推广快捷入口** - 从首页操作菜单直接置顶
4. **优化菜单结构** - 区分商家和用户看到的菜单选项

## 数据库变更

### 执行SQL脚本

请在 Supabase SQL Editor 中执行以下脚本：

**文件路径**: `scripts/011_add_reports_and_status.sql`

该脚本包含：

1. **添加商家上架状态字段**
   ```sql
   ALTER TABLE merchants
   ADD COLUMN IF NOT EXISTS is_active BOOLEAN DEFAULT true;
   ```

2. **创建举报表**
   - `reports` 表存储用户举报记录
   - 字段：merchant_id, reporter_id, reason, details, status, admin_notes
   - 状态：pending（待处理）, reviewing（审核中）, resolved（已处理）, rejected（已驳回）

3. **索引优化**
   - 为提升查询性能，创建了多个索引

4. **RLS策略**
   - 用户可以创建举报
   - 用户可以查看自己提交的举报
   - 商家可以查看针对自己的举报

## 执行步骤

1. 登录 Supabase Dashboard
2. 进入 SQL Editor
3. 打开 `scripts/011_add_reports_and_status.sql` 文件
4. 复制全部内容到 SQL Editor
5. 点击"Run"执行脚本
6. 确认执行成功，没有报错

## 新增功能说明

### 1. 商家菜单（商家看自己的服务）

- ✏️ **编辑** - 编辑商家信息（扣100积分）
- 👁️ **查看详情** - 查看完整商家信息
- 🚀 **置顶推广** - 快速置顶推广入口（100积分/天）
- 📴 **暂时下架/重新上架** - 灵活管理展示状态

### 2. 用户菜单（用户看其他商家）

- 👁️ **查看详情** - 查看完整商家信息
- ⭐ **收藏** - 收藏商家到"我的收藏"
- ⚠️ **举报** - 举报违规商家

### 3. 举报流程

1. 用户点击"举报"
2. 选择举报原因：
   - 信息虚假
   - 服务态度差
   - 疑似诈骗
   - 重复发布
   - 内容不当
   - 其他原因
3. 填写详细说明（必填）
4. 提交举报
5. 系统记录举报信息，状态为"待处理"

### 4. 上下架功能

- 商家可以暂时下架自己的服务（不删除数据）
- 下架后，服务不在首页显示
- 可随时重新上架
- 适用场景：库存不足、暂停服务、临时维护

### 5. 置顶推广快捷入口

- 从首页操作菜单直接进入置顶
- 输入置顶天数（1-30天）
- 显示所需积分（100积分/天）
- 积分不足时自动禁用
- 两步确认流程防止误操作

## 组件文件

### 新增组件

1. **ReportDialog** - `components/report-dialog.tsx`
   - 举报对话框组件
   - 包含举报原因选择、详细说明输入
   - 自动提交到reports表

### 更新组件

1. **app/page.tsx** - 首页
   - 更新下拉菜单结构
   - 添加置顶推广对话框
   - 整合举报功能
   - 添加上下架操作

2. **lib/actions/merchant.ts** - 商家操作
   - 添加 `deactivateMerchant()` 下架功能
   - 添加 `activateMerchant()` 上架功能
   - 更新 `getMerchants()` 过滤已下架商家

## 测试清单

### 商家功能测试

- [ ] 商家可以看到"编辑"、"查看详情"、"置顶推广"、"暂时下架"菜单
- [ ] 点击"编辑"会弹出积分确认对话框
- [ ] 点击"置顶推广"可以输入天数并确认
- [ ] 点击"暂时下架"可以成功下架商家
- [ ] 下架后，商家不在首页显示
- [ ] 商家下架后，菜单变为"重新上架"
- [ ] 点击"重新上架"可以成功上架

### 用户功能测试

- [ ] 用户可以看到"查看详情"、"收藏"、"举报"菜单
- [ ] 点击"举报"弹出举报对话框
- [ ] 可以选择举报原因
- [ ] 必须填写详细说明才能提交
- [ ] 提交后显示成功提示
- [ ] 举报记录保存到数据库

### 权限测试

- [ ] 用户不能编辑其他商家
- [ ] 用户不能下架其他商家
- [ ] 商家不能举报自己
- [ ] 商家可以查看针对自己的举报

## 注意事项

1. **执行SQL脚本前请备份数据库**
2. **积分确认** - 置顶推广需要足够积分
3. **RLS策略** - 确保已启用Row Level Security
4. **下架状态** - 下架的商家默认 `is_active = false`
5. **举报处理** - 管理员需要在后台处理举报记录

## 常见问题

### Q: 执行SQL脚本报错怎么办？
A: 检查是否已经执行过该脚本，如果字段已存在会报错。可以删除 `IF NOT EXISTS` 再试。

### Q: 下架后商家是否还能访问？
A: 可以。商家依然可以通过直接URL访问详情页，只是不在首页列表显示。

### Q: 举报记录可以删除吗？
A: 建议保留所有举报记录作为审计日志。可以修改status为"resolved"表示已处理。

### Q: 置顶推广可以续费吗？
A: 可以。在置顶期内再次点击"置顶推广"即可延长时间。

## 下一步计划

可选的后续优化：
- [ ] 管理员后台查看和处理举报
- [ ] 商家数据统计页面
- [ ] 商家对比功能
- [ ] 分享链接功能
- [ ] 批量管理商家状态
