# 邀请次数限制系统实现说明

## 概述

根据您的要求，我已经成功实现了**方案1：限制邀请次数**的完整功能。这个系统可以有效控制内测期间的用户增长速度，同时保留了多级邀请链的能力。

## 已实现的功能

### 1. 数据库层面 ✅

**文件**: `scripts/086_add_invitation_limits.sql`

添加了以下字段和功能:

#### profiles 表新增字段
- `max_invitations`: 用户可以邀请的最大人数（默认5人）
- `used_invitations`: 用户已经使用的邀请次数

#### system_settings 表新增字段
- `default_max_invitations`: 新用户的默认邀请次数上限（默认5）

#### 数据库函数
```sql
-- 获取用户剩余邀请次数
get_remaining_invitations(user_id UUID) RETURNS INTEGER

-- 检查用户是否还可以邀请
can_user_invite(user_id UUID) RETURNS BOOLEAN
```

#### 数据库触发器
- `on_invitation_completed`: 当邀请记录状态变为 completed 时，自动增加邀请人的 `used_invitations`

#### 数据修复
- 自动计算并更新现有用户的 `used_invitations` 字段

### 2. 后端逻辑层面 ✅

**文件**: `lib/actions/invitation.ts`

#### getUserInvitationCode() 函数更新
- 检查用户是否还有剩余邀请次数
- 如果次数用完且没有邀请码，抛出错误提示
- 如果已有邀请码，仍然返回（用户可以查看自己的邀请码）

```typescript
// 检查是否还有邀请次数
const maxInvitations = profile?.max_invitations || 5
const usedInvitations = profile?.used_invitations || 0
const remainingInvitations = Math.max(maxInvitations - usedInvitations, 0)

// 如果没有剩余次数，不允许生成邀请码（但如果已有邀请码，仍然返回）
if (remainingInvitations <= 0 && !profile?.invitation_code) {
  throw new Error("您的邀请次数已用完，无法生成新的邀请码")
}
```

#### getInvitationStats() 函数更新
返回值新增以下字段：
- `maxInvitations`: 用户的邀请次数上限
- `usedInvitations`: 已使用的次数
- `remainingInvitations`: 剩余次数

#### processInvitationReward() 函数更新
- 在处理邀请奖励前，检查邀请人是否还有剩余邀请次数
- 如果次数用完，直接返回 null，不处理奖励

```typescript
// 检查邀请人是否还有剩余邀请次数
const maxInvitations = inviterProfile.max_invitations || 5
const usedInvitations = inviterProfile.used_invitations || 0
const remainingInvitations = Math.max(maxInvitations - usedInvitations, 0)

if (remainingInvitations <= 0) {
  console.error("[服务端] 邀请人的邀请次数已用完")
  return null
}
```

### 3. 前端用户界面 ✅

**文件**: `app/invitations/page.tsx`

#### 邀请次数提示框
- 显示用户当前剩余的邀请次数
- 显示已使用/总次数（例如：已使用 3/5）
- 次数用完时显示橙色警告提示

```tsx
{stats && (
  <Alert className={stats.remainingInvitations > 0 ? "bg-blue-50 border-blue-200" : "bg-orange-50 border-orange-200"}>
    <Gift className={`h-4 w-4 ${stats.remainingInvitations > 0 ? "text-blue-600" : "text-orange-600"}`} />
    <AlertDescription>
      {stats.remainingInvitations > 0 ? (
        <>您当前还可以邀请 <strong>{stats.remainingInvitations}</strong> 位好友（已使用 {stats.usedInvitations}/{stats.maxInvitations}）</>
      ) : (
        <>您的邀请次数已用完（{stats.usedInvitations}/{stats.maxInvitations}），如需更多邀请机会请联系管理员</>
      )}
    </AlertDescription>
  </Alert>
)}
```

#### 统计卡片新增
- 在统计卡片区域最前面新增"剩余次数"卡片
- 使用橙色图标突出显示

### 4. 管理员控制功能 ✅

**文件**: `lib/actions/users.ts`

#### UserProfile 接口更新
```typescript
export interface UserProfile {
  // ... 其他字段
  max_invitations?: number
  used_invitations?: number
}
```

#### 新增管理员函数
```typescript
/**
 * 更新用户的邀请次数限制（仅限管理员）
 */
export async function updateUserInvitationLimit(userId: string, maxInvitations: number)
```

功能：
- 验证管理员权限
- 验证邀请次数不能为负数
- 更新用户的 max_invitations 字段
- 返回操作结果

#### adminGetUsers 函数更新
- 查询用户列表时包含 `max_invitations` 和 `used_invitations` 字段

## 使用方法

### 普通用户视角

1. **查看邀请次数**
   - 访问 `/invitations` 页面
   - 页面顶部会显示剩余邀请次数和已使用情况
   - 统计卡片第一个就是"剩余次数"

2. **邀请好友**
   - 如果还有剩余次数，可以正常复制邀请码或邀请链接
   - 如果次数用完，会看到橙色提示："您的邀请次数已用完，如需更多邀请机会请联系管理员"

3. **被邀请人也可以邀请**
   - 被邀请人注册成功后，自动获得默认的邀请次数（5次）
   - 可以继续邀请其他人，形成多级邀请链

### 管理员视角

#### 方法1：直接使用数据库函数（推荐用于批量操作）

```javascript
// 在 Node.js 脚本或 Supabase Dashboard 中执行

// 1. 为特定用户设置邀请次数
const { data } = await supabase
  .from('profiles')
  .update({ max_invitations: 10 })  // 设置为10次
  .eq('id', 'user-id-here')

// 2. 为测试用户批量增加邀请次数
const { data } = await supabase
  .from('profiles')
  .update({ max_invitations: 20 })  // 测试用户给20次
  .eq('role', 'tester')  // 假设您标记了测试用户

// 3. 为所有用户统一增加邀请次数
const { data } = await supabase
  .from('profiles')
  .update({
    max_invitations: supabase.raw('max_invitations + 5')  // 每人增加5次
  })
```

#### 方法2：通过代码调用管理员函数

```typescript
import { updateUserInvitationLimit } from '@/lib/actions/users'

// 更新用户的邀请次数上限
const result = await updateUserInvitationLimit('user-id', 10)

if (result.success) {
  console.log('更新成功')
} else {
  console.error('更新失败:', result.error)
}
```

#### 方法3：在管理后台添加 UI（待实现）

虽然我已经创建了后端函数，但完整的管理后台 UI 需要在 `app/admin/users/page.tsx` 中添加对话框和按钮。

您可以参考以下步骤自行添加：

1. **添加对话框状态**
```typescript
const [invitationLimitDialogOpen, setInvitationLimitDialogOpen] = useState(false)
const [newMaxInvitations, setNewMaxInvitations] = useState(5)
```

2. **添加处理函数**
```typescript
const handleInvitationLimitClick = (user: UserProfile) => {
  setSelectedUser(user)
  setNewMaxInvitations(user.max_invitations || 5)
  setInvitationLimitDialogOpen(true)
}

const handleUpdateInvitationLimit = async () => {
  if (!selectedUser) return

  const result = await updateUserInvitationLimit(selectedUser.id, newMaxInvitations)

  if (result.success) {
    toast.success('邀请次数已更新')
    setInvitationLimitDialogOpen(false)
    loadUsers()  // 重新加载用户列表
  } else {
    toast.error(result.error || '更新失败')
  }
}
```

3. **在用户详情对话框中显示邀请信息**
在 `app/admin/users/page.tsx` 的用户详情对话框中（约第768行之后）添加：

```tsx
<div>
  <Label className="text-muted-foreground">邀请次数</Label>
  <p className="font-medium">
    已使用 {selectedUser.used_invitations || 0} / {selectedUser.max_invitations || 5}
    （剩余 {Math.max((selectedUser.max_invitations || 5) - (selectedUser.used_invitations || 0), 0)} 次）
  </p>
</div>
```

4. **添加操作按钮**
在用户操作按钮区域（约第682行）添加：

```tsx
<Button
  size="sm"
  variant="ghost"
  className="text-purple-600 hover:text-purple-700 hover:bg-purple-50"
  onClick={() => handleInvitationLimitClick(user)}
>
  <Users className="h-4 w-4" />
</Button>
```

## 系统特性

### ✅ 支持多级邀请链
- 用户A邀请用户B（A的次数 -1）
- 用户B注册后获得5次邀请机会
- 用户B可以邀请用户C（B的次数 -1）
- 以此类推，支持无限层级

### ✅ 灵活的次数控制
- 每个用户独立计数
- 管理员可以单独调整任何用户的邀请次数
- 可以通过数据库批量修改不同用户组的次数

### ✅ 自动计数
- 使用数据库触发器自动更新
- 不需要手动维护计数
- 避免计数不一致的问题

### ✅ 友好的用户提示
- 实时显示剩余次数
- 次数用完时有明确的提示
- 引导用户联系管理员获取更多邀请机会

## 数据库迁移步骤

要应用这些更改，需要执行数据库迁移：

### 方式1：通过 Supabase Dashboard（推荐）

1. 登录 Supabase Dashboard
2. 进入 SQL Editor
3. 将 `scripts/086_add_invitation_limits.sql` 的内容粘贴到编辑器
4. 点击 Run 执行

### 方式2：通过命令行

```bash
# 如果您有配置 Supabase CLI
supabase db reset  # 重置数据库（开发环境）

# 或者直接执行迁移文件
psql your_database_url < scripts/086_add_invitation_limits.sql
```

## 测试建议

### 1. 功能测试

#### 测试用户邀请流程
```
1. 创建测试用户A（默认5次邀请）
2. 用户A生成邀请码
3. 用户A邀请5个用户（B、C、D、E、F）
4. 验证：用户A的 used_invitations = 5，remaining = 0
5. 尝试用户A再邀请用户G
6. 预期结果：注册页面使用邀请码会失败（邀请码已达上限）
```

#### 测试多级邀请
```
1. 用户A邀请用户B（A: 4/5）
2. 用户B注册成功，获得默认5次邀请（B: 0/5）
3. 用户B邀请用户C（B: 1/5）
4. 用户C注册成功，获得默认5次邀请（C: 0/5）
5. 验证：A、B、C 都有独立的邀请次数计数
```

#### 测试管理员调整
```
1. 管理员将用户A的 max_invitations 从5改为10
2. 验证：用户A的剩余次数正确更新
3. 用户A可以继续邀请
```

### 2. 边界测试

- 邀请次数为0的用户
- 负数邀请次数（应该被拒绝）
- 已有邀请码但次数用完的用户（应该能看到邀请码，但不能使用）
- 并发邀请（多人同时使用同一个人的邀请码）

### 3. 性能测试

- 大量用户同时邀请
- 邀请链深度测试（A->B->C->D->E...）
- 数据库触发器性能

## 后续优化建议

### 1. 管理后台完整 UI ⚠️ 待实现
虽然后端函数已经完成，但建议在管理后台添加：
- 邀请次数调整对话框
- 批量调整邀请次数功能
- 邀请链可视化（查看谁邀请了谁）
- 邀请统计图表

### 2. 高级功能
- **邀请码过期时间**：限制邀请码的有效期
- **邀请次数自动恢复**：例如每月重置邀请次数
- **VIP用户更多邀请次数**：根据用户等级给不同的邀请次数
- **邀请奖励梯度**：邀请的人越多，奖励越高
- **邀请排行榜**：显示邀请人数最多的用户

### 3. 监控和分析
- 邀请转化率统计
- 邀请链分析（哪个用户的邀请链最长）
- 邀请热力图（哪些时段邀请最多）

## 故障排查

### 问题1：邀请次数没有自动减少
**原因**：触发器可能没有正确创建
**解决**：
```sql
-- 检查触发器是否存在
SELECT * FROM pg_trigger WHERE tgname = 'on_invitation_completed';

-- 重新创建触发器
-- 执行 scripts/086_add_invitation_limits.sql 中的触发器部分
```

### 问题2：现有用户的 used_invitations 不准确
**原因**：迁移时数据修复没有执行
**解决**：
```sql
-- 手动修复所有用户的 used_invitations
UPDATE profiles p
SET used_invitations = (
  SELECT COUNT(*)
  FROM invitations i
  WHERE i.inviter_id = p.id
    AND i.status = 'completed'
);
```

### 问题3：用户提示邀请次数用完，但数据库显示还有
**原因**：前端缓存或 RLS 策略问题
**解决**：
```typescript
// 清除用户缓存，重新获取数据
const stats = await getInvitationStats()
```

## 总结

邀请次数限制系统已经完整实现，包括：

✅ 数据库字段和触发器
✅ 后端验证逻辑
✅ 前端用户界面
✅ 管理员控制函数
✅ 多级邀请支持
✅ 自动计数系统

系统可以立即投入使用，满足内测阶段控制用户增长的需求。被邀请人注册后可以继续邀请其他人，形成多级邀请链，每个用户都有独立的邀请次数限制。

如需调整默认邀请次数或为特定用户增加邀请机会，可以通过管理员函数或直接修改数据库实现。
