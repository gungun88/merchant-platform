# 内测邀请码系统完整实现说明

## 已完成部分

### 1. 数据库层 ✅
文件：`scripts/087_create_beta_codes_system.sql`

已创建：
- `beta_codes` 表：存储内测邀请码
- `beta_code_usages` 表：记录内测码使用情况
- 数据库函数：`validate_beta_code()` 和 `record_beta_code_usage()`
- RLS 策略：仅管理员可管理
- `system_settings.beta_code_required` 字段：控制是否需要内测码

### 2. 后端 API ✅
文件：`lib/actions/beta-codes.ts`

已实现的函数：
- `validateBetaCode()` - 验证内测码是否有效
- `recordBetaCodeUsage()` - 记录内测码使用
- `getBetaCodes()` - 获取所有内测码（管理员）
- `createBetaCode()` - 创建单个内测码（管理员）
- `createBatchBetaCodes()` - 批量创建内测码（管理员）
- `updateBetaCode()` - 更新内测码（管理员）
- `deleteBetaCode()` - 删除内测码（管理员）
- `getBetaCodeUsages()` - 获取使用记录（管理员）

## 需要执行的步骤

### 步骤1：执行数据库迁移

在 Supabase Dashboard 的 SQL Editor 中执行 `scripts/087_create_beta_codes_system.sql`

### 步骤2：修改注册页面

由于您的注册页面已经有邀请码功能，现在需要添加内测码支持。

**关键修改点**：

#### 2.1 添加导入
在 `app/auth/register/page.tsx` 的第15行后添加：

```typescript
import { validateBetaCode, recordBetaCodeUsage } from "@/lib/actions/beta-codes"
```

#### 2.2 添加状态变量
在第26-36行的状态声明区域添加：

```typescript
const [betaCode, setBetaCode] = useState("")
const [betaCodeValid, setBetaCodeValid] = useState<boolean | null>(null)
const [betaCodeRequired, setBetaCodeRequired] = useState(false)
const [validatedBetaCodeId, setValidatedBetaCodeId] = useState<string | null>(null)
```

#### 2.3 修改系统设置加载
在第87-96行的 `loadSettings()` 函数中添加：

```typescript
async function loadSettings() {
  const result = await getSystemSettings()
  if (result.success && result.data) {
    setInvitationCodeRequired(result.data.invitation_code_required ?? false)
    setBetaCodeRequired(result.data.beta_code_required ?? false)  // 新增
  }
}
```

#### 2.4 添加内测码实时验证
在第137-146行的邀请码验证 useEffect 后面添加：

```typescript
// 当内测码改变时验证
useEffect(() => {
  if (betaCode) {
    validateBetaCode(betaCode).then((result) => {
      if (result.success && result.valid) {
        setBetaCodeValid(true)
        setValidatedBetaCodeId(result.betaCodeId || null)
      } else {
        setBetaCodeValid(false)
        setValidatedBetaCodeId(null)
      }
    })
  } else {
    setBetaCodeValid(null)
    setValidatedBetaCodeId(null)
  }
}, [betaCode])
```

#### 2.5 在注册处理函数中添加内测码验证
在第148行的 `handleRegister` 函数中，在邮箱验证之前（约第170行之前）添加：

```typescript
// 验证内测码（如果必填）
if (betaCodeRequired) {
  if (!betaCode) {
    setError("内测邀请码为必填项")
    setIsLoading(false)
    return
  }

  if (betaCodeValid === false || !validatedBetaCodeId) {
    setError("内测邀请码无效，请检查后重试")
    setIsLoading(false)
    return
  }
}
```

#### 2.6 在注册成功后记录内测码使用
在第253行 `router.push("/auth/register-success")` 之前添加：

```typescript
// 记录内测码使用（如果使用了内测码）
if (betaCode && betaCodeValid && validatedBetaCodeId) {
  try {
    console.log("记录内测码使用...")
    await recordBetaCodeUsage(validatedBetaCodeId, betaCode, data.user.id)
    console.log("内测码使用记录成功")
  } catch (betaCodeError) {
    console.error("记录内测码使用失败:", betaCodeError)
    // 不影响注册流程
  }
}
```

#### 2.7 在 UI 中添加内测码输入框
在第400-419行的邀请码输入框之前添加：

```tsx
{/* 内测邀请码 */}
{betaCodeRequired && (
  <div className="grid gap-2">
    <Label htmlFor="beta-code">
      内测邀请码<span className="text-red-500 ml-1">*</span>
    </Label>
    <Input
      id="beta-code"
      type="text"
      placeholder="请输入管理员提供的内测邀请码"
      value={betaCode}
      onChange={(e) => setBetaCode(e.target.value.toUpperCase())}
      required={betaCodeRequired}
    />
    {betaCode && betaCodeValid === false && (
      <p className="text-sm text-red-500">内测邀请码无效、已过期或已达使用上限</p>
    )}
    {betaCode && betaCodeValid === true && (
      <p className="text-sm text-green-600">内测邀请码有效</p>
    )}
  </div>
)}
```

### 步骤3：启用内测码功能

在数据库中设置：

```sql
UPDATE system_settings
SET beta_code_required = true;
```

或者通过管理后台的系统设置页面开启。

### 步骤4：创建管理后台内测码管理页面

创建新文件：`app/admin/beta-codes/page.tsx`

这个页面应该包含：
1. 内测码列表（代码、描述、使用情况、状态）
2. 创建单个内测码的对话框
3. 批量生成内测码的对话框
4. 查看使用记录的对话框
5. 启用/禁用内测码的开关
6. 导出内测码列表功能

由于代码量较大，建议分步实现。我可以帮您创建基础页面框架。

## 内测码使用流程

### 管理员视角
1. 登录管理后台
2. 进入"内测邀请码管理"页面
3. 点击"生成内测码"
4. 设置参数：
   - 生成数量（或自定义码）
   - 用途说明（如"种子用户"）
   - 使用次数（默认1次）
   - 过期时间（可选）
5. 生成后将内测码发放给测试用户

### 用户视角
1. 访问注册页面
2. 填写基本信息
3. **输入管理员提供的内测邀请码**（必填）
4. 系统实时验证内测码有效性
5. （可选）输入用户邀请码
6. 注册成功

### 两种邀请码的区别

| 特性 | 内测邀请码 | 用户邀请码 |
|------|-----------|-----------|
| **发放者** | 管理员 | 普通用户 |
| **用途** | 控制注册权限 | 推广奖励 |
| **是否必填** | 可配置（建议内测期必填） | 可选 |
| **使用次数** | 管理员设置（1-N次或无限） | 每人固定次数（5次） |
| **奖励** | 无 | 双方各得积分 |
| **管理方式** | 管理后台统一管理 | 用户自行生成和使用 |

## 推荐配置

### 内测阶段（现在）
```sql
UPDATE system_settings
SET
  beta_code_required = true,          -- 必须使用内测码
  invitation_code_required = false;   -- 用户邀请码可选
```

这样可以：
- ✅ 控制谁可以注册（只有拿到内测码的人）
- ✅ 允许用户使用邀请码获得额外奖励
- ✅ 统计每个内测码带来的用户数量

### 公测阶段（未来）
```sql
UPDATE system_settings
SET
  beta_code_required = false,         -- 不需要内测码
  invitation_code_required = false;   -- 用户邀请码可选
```

## 快速测试

1. 执行数据库迁移
2. 生成一个测试内测码：

```sql
INSERT INTO beta_codes (code, description, max_uses)
VALUES ('TEST2024', '测试用内测码', 10);
```

3. 启用内测码要求：

```sql
UPDATE system_settings SET beta_code_required = true;
```

4. 访问注册页面，使用 `TEST2024` 注册
5. 查看使用记录：

```sql
SELECT
  bc.code,
  bc.description,
  bc.used_count,
  bc.max_uses,
  bcu.used_at,
  p.username,
  p.email
FROM beta_codes bc
LEFT JOIN beta_code_usages bcu ON bc.id = bcu.beta_code_id
LEFT JOIN profiles p ON bcu.user_id = p.id
WHERE bc.code = 'TEST2024'
ORDER BY bcu.used_at DESC;
```

## 下一步

需要我帮您：
1. ✅ 创建管理后台的内测码管理页面？
2. ✅ 修改注册页面的完整代码？
3. ✅ 创建内测码使用情况的统计报表？

选择您需要的功能，我会继续实现！
