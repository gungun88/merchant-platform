# 邀请码必填配置功能说明

## 功能概述
在管理后台添加了"邀请码必填"开关，管理员可以控制用户注册时邀请码字段是必填还是选填。

## 实现内容

### 1. 数据库修改
**文件**: `scripts/028_add_invitation_code_required_setting.sql`

- 在 `system_settings` 表中添加 `invitation_code_required` 字段（布尔类型）
- 默认值为 `FALSE`（选填模式）

### 2. 后端类型定义更新
**文件**: `lib/actions/settings.ts`

在 `SystemSettings` 和 `UpdateSettingsData` 接口中添加：
```typescript
// 邀请码配置
invitation_code_required: boolean
```

### 3. 管理后台设置页面
**文件**: `app/admin/settings/page.tsx`

在"邮箱验证配置"部分的末尾添加了邀请码必填开关：

| 配置项 | 配置值 | 说明 |
|--------|--------|------|
| 邀请码必填 | Switch开关 | 开启后用户注册时必须填写邀请码 |

**位置**: 行947-960

### 4. 注册页面修改
**文件**: `app/auth/register/page.tsx`

#### 4.1 添加状态管理
- 添加 `invitationCodeRequired` 状态来存储系统设置
- 在组件加载时从系统设置中获取配置值

#### 4.2 表单验证增强
在 `handleRegister` 函数中添加两项验证：
1. **邀请码必填验证**：如果设置为必填且用户未填写，提示错误
2. **邀请码有效性验证**：如果用户填写了邀请码但无效，提示错误

#### 4.3 UI动态调整
- Label显示：
  - 必填时：显示 `邀请码 *`（红色星号）
  - 选填时：显示 `邀请码 (选填)`（灰色文字）
- Placeholder变化：
  - 必填时：`请输入邀请码（必填）`
  - 选填时：`如果有邀请码请输入`
- Input的 `required` 属性根据配置动态设置

## 使用方法

### 管理员操作
1. 登录管理后台
2. 进入【系统设置】页面
3. 找到"邮箱验证配置"部分
4. 在最后一行找到"邀请码必填"开关
5. 开启或关闭该开关
6. 点击【保存设置】按钮

### 用户体验
- **选填模式**（默认）：
  - 用户注册时可以选择填写或不填写邀请码
  - 邀请码字段显示为"邀请码 (选填)"

- **必填模式**：
  - 用户注册时必须填写邀请码
  - 邀请码字段显示为"邀请码 *"（红色星号）
  - 如果不填写或填写无效邀请码，会显示错误提示，无法完成注册

## 验证流程

```
用户点击注册
  ↓
检查邀请码是否必填
  ↓
【必填模式】→ 检查是否已填写 → 未填写 → 显示错误
  ↓                              ↓
  已填写                          已填写
  ↓                              ↓
检查邀请码是否有效
  ↓
无效 → 显示错误
  ↓
有效 → 继续验证邮箱和密码...
```

## 技术细节

### 数据流
1. 管理员在后台开启/关闭邀请码必填开关
2. 设置保存到 `system_settings.invitation_code_required` 字段
3. 注册页面加载时通过 `getSystemSettings()` 获取配置
4. 根据配置值动态调整UI和验证逻辑

### 兼容性
- 向后兼容：默认值为 `FALSE`，保持原有的选填行为
- 现有用户不受影响

## 相关文件清单
- `scripts/028_add_invitation_code_required_setting.sql` - 数据库迁移脚本
- `lib/actions/settings.ts` - 系统设置类型定义
- `app/admin/settings/page.tsx` - 管理后台设置页面
- `app/auth/register/page.tsx` - 用户注册页面

## 测试建议
1. 测试选填模式（默认）
   - 不填写邀请码能否正常注册
   - 填写有效邀请码能否获得奖励

2. 测试必填模式
   - 不填写邀请码是否阻止注册
   - 填写无效邀请码是否阻止注册
   - 填写有效邀请码能否正常注册并获得奖励

3. 测试管理后台
   - 开关切换是否正常保存
   - 设置变更后注册页面是否立即生效
